---
title: "Compte rendu TP4 — Tests statistiques (ANOVA)"
author: "Laroussi Labid Bachri, M1 BBS"
date: "`r format(Sys.Date(), '%d-%m-%Y')`"
output:
  html_document:
    toc: true
    theme: flatly
  pdf_document:
    toc: true
editor_options:
  chunk_output_type: console
params:
  # chemins par défaut (relatifs à la racine du dépôt)
  fichier_resistance: "TP4_ANOVA/data/resistance.txt"
  fichier_croissance: "TP4_ANOVA/data/croissance.txt"
  fichier_vache:      "TP4_ANOVA/data/vache.txt"
---

```{r setup, include=FALSE}
set.seed(42)
options(stringsAsFactors = FALSE)

if (!requireNamespace("here", quietly = TRUE)) install.packages("here")
library(here)

# Dossiers
path_output <- here("TP4_ANOVA", "output")
dir.create(path_output, showWarnings = FALSE, recursive = TRUE)

# Knit depuis la racine du repo
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE,
  fig.width = 6, fig.height = 4, dpi = 150,
  fig.path = file.path(path_output, "")
)

# Packages
if (!requireNamespace("agricolae", quietly = TRUE)) install.packages("agricolae")
library(agricolae)
```

# Analyse de la variance (ANOVA)

Exploration jeu de données 

## ANOVA à 1 facteur (une variable qualitative)


```{r import, include=FALSE}
# Fichiers (via params) + contrôles d'existence
files_ok <- all(
  file.exists(here::here(params$fichier_resistance)),
  file.exists(here::here(params$fichier_croissance)),
  file.exists(here::here(params$fichier_vache))
)
stopifnot(files_ok)

resistance <- read.table(
  here::here(params$fichier_resistance),
  header = TRUE, sep = "", quote = "", comment.char = "",
  stringsAsFactors = TRUE
)

croissance <- read.table(
  here::here(params$fichier_croissance),
  header = TRUE, sep = "", quote = "", comment.char = "",
  stringsAsFactors = TRUE
)

vache <- read.table(
  here::here(params$fichier_vache),
  header = TRUE, sep = "", quote = "", comment.char = "",
  stringsAsFactors = TRUE
)

str(resistance); str(croissance); str(vache)
```


```{r Exploration_jeu_de_donnes}
head(resistance) ; tail(resistance)
names(resistance)

table(resistance$lignee)

tapply(resistance$score, resistance$lignee , mean )
# va appliquer la fonction mean sur le score et les regrouper par lignees.
tapply(resistance$score, resistance$lignee, summary)
# va appliquer la fonction summary sur le score et les regrouper par lignees.
hist(resistance$score, breaks=15, ylab="effectifs" )


boxplot(resistance$score~resistance$lignee, col="green", ylab="score")

```


## Test d'adéquation à la loi normale (H0 = "les données suivent la loi Normale")
```{r Tests_prealable_ANOVA}

shapiro.test(resistance$score[resistance$lignee=="HM008"])
shapiro.test(resistance$score[resistance$lignee=="A17"] )
shapiro.test(resistance$score[resistance$lignee=="DZA45"])
shapiro.test(resistance$score[resistance$lignee=="HM013"])
# Ou on fait tapply
tapply(resistance$score, resistance$lignee , shapiro.test )
```
On observe que les p value sont toutes superieures a 0.05 donc on accpete l'hypothese nulle.

## Test d'homogénéité des variances intra-groupes (H0 : "les variances sont égales")

```{r}


bartlett.test(resistance$score~resistance$lignee)


```

On trouve une p value de 0.6988. Les groupes ont donc des variances homogènes. 


## ANOVA à 1 facteur (le facteur est la variable "resistance$resistance$lignee") → H0 :"les moyennes des différents groupes sont égales"

```{r Test_Anova}
res = aov(resistance$score~resistance$lignee) # Test ANOVA

summary(res) # Afficher tableau ANOVA.
# Df = degre de liberte 
# sum square = somme ecart a la moyenne.

# Aire sous la courbe, p value = 1.18e-5. 
```


Toutes les moyennes ne sont pas egales. p value = 1.18e-5.

```{r visualiser_moyennees_chaque_groupe}

model.tables(res)

tapply(resistance$score , resistance$lignee , mean) - mean(resistance$score) # Differences de la moyenne par rapport a moyenne generale.

t.test(resistance$score[resistance$lignee=="DZA45"], resistance$score[resistance$lignee=="HM013"], var.equal=T) 
t.test(resistance$score[resistance$lignee=="DZA45"], resistance$score[resistance$lignee=="HM008"], var.equal=T)
t.test(resistance$score[resistance$lignee=="DZA45"], resistance$score[resistance$lignee=="A17"], var.equal=T)
t.test(resistance$score[resistance$lignee=="A17"], resistance$score[resistance$lignee=="HM013"], var.equal=T)
t.test(resistance$score[resistance$lignee=="HM008"], resistance$score[resistance$lignee=="HM013"], var.equal=T)
t.test(resistance$score[resistance$lignee=="A17"], resistance$score[resistance$lignee=="HM008"], var.equal=T)

pairwise.t.test(resistance$score , resistance$lignee , pool.sd=F, p.adjust.method = "bonferroni" , var.equal=T)

# il va faire les tests 2 a 2 

# bonferroni va multipliler les p values et diviser le seuil par le nombre de tests. 

```

On trouve une difference significative du score entre DZA45 et HM013.
On trouve une difference significative du score entre DZA45 et HM008.
On trouve une difference significative du score entre DZA45 et A17.

On trouve une difference significative du score entre A17 et HM008.


# On peut aussi faire un test de Duncan (l'intérêt étant qu'il propose de classer les groupes en groupes similaires a, b, etc.) :

```{r}
duncan.test(res, "lignee", alpha=0.01, console=T)
```

La lignée DZA45 est significativement plus resistance comparé aux autres lignées.

# ANOVA à 2 facteurs (deux variables qualitatives) 
## Exploration jeu de données 


```{r}

head(croissance)

                         
layout( matrix( c(1,2,3,3) , nrow=2, ncol=2, byrow = FALSE))
boxplot(croissance$hauteur~croissance$engrais, main="engrais", ylab="hauteur (cm)")
boxplot(croissance$hauteur~croissance$temperature, main="temperature", ylab="hauteur (cm)")
boxplot(croissance$hauteur~croissance$temperature+croissance$engrais, main="engrais-temperature", ylab="hauteur (cm)", las=3)                        

```


## Tests préalables à l'ANOVA
Test d'adéquation à la loi normale (H0 : "les données suivent la loi Normale")
Test de Shapiro

```{r}
# remarque: pour sélectionner les lignes correspondant à une combinaison de facteur colonnes, on utilise "&":
shapiro.test(croissance$hauteur[croissance$engrais=="A" & croissance$temperature=="Medium"])
shapiro.test(croissance$hauteur[croissance$engrais=="A" & croissance$temperature=="High"])
shapiro.test(croissance$hauteur[croissance$engrais=="B" & croissance$temperature=="Medium"])
shapiro.test(croissance$hauteur[croissance$engrais=="B" & croissance$temperature=="High"])

```

Toules les p-value sont supeireurs a 0.05. Toutes les donnees suivent une loi normale. 


Test d'homogénéité des variances intra-groupes (H0 : "les variances sont égales")
Test de Bartlett de comparaison de plus de 2 variances :

```{r}
bartlett.test(croissance$hauteur~interaction(croissance$temperature,croissance$engrais))

```

La p-value est de 0.493. Les variances sont donc égales. 

# ANOVA à 2 facteurs (les facteurs sont "engrais" et "température") → H0 : "les moyennes des différents groupes sont égales"

##. Modèle d'ANOVA où l'on teste l'effet de 2 facteurs ainsi que leur interaction


```{r}
model1 <- aov(croissance$hauteur~croissance$temperature*croissance$engrais)	
summary(model1)
interaction.plot(croissance$temperature, croissance$engrais, croissance$hauteur, main="interaction plot")
```

 
On trouve une p-value de 3.07e-05. 
 
## Modèle d'ANOVA où l'on teste l'effet de 2 facteurs sans leur interaction
```{r}

model2 <- aov(croissance$hauteur~croissance$temperature+croissance$engrais)	
summary(model2)

```

O trouve une p-value de 0.000125

## Comparaison des 2 modèles avec une ANOVA sur les résidus des 2 modèles
```{r}

anova(model1, model2)
```

On trouve une p-value de 0.02303. 

On trouve une differnce significative entre ces 2 modeles.
Nous allons donc garder le modele car on trouve plus de differneces. 

La température influence significativement la hauteur, et l’effet de l’croissance$engrais dépend de la température.


```{r}

# plantes avec "engrais" différents
t.test(croissance$hauteur[croissance$engrais=="A" & croissance$temperature=="High"], croissance$hauteur[croissance$engrais=="B" & croissance$temperature=="High"], var.equal=T)     # comparaison A/B pour température "High"
t.test(croissance$hauteur[croissance$engrais=="A" & croissance$temperature=="Medium"], croissance$hauteur[croissance$engrais=="B" & croissance$temperature=="Medium"], var.equal=T) # comparaison A/B pour température "Medium"
# plantes avec "températures" différentes
t.test(croissance$hauteur[croissance$engrais=="A" & croissance$temperature=="Medium"], croissance$hauteur[croissance$engrais=="A" & croissance$temperature=="High"], var.equal=T)   # comparaison High/Medium pour l'engrais A
t.test(croissance$hauteur[croissance$engrais=="B" & croissance$temperature=="Medium"], croissance$hauteur[croissance$engrais=="B" & croissance$temperature=="High"], var.equal=T)   # comparaison High/Medium pour l'engrais B

```


On trouve une difference significative uniquement entre le changement de temperature ( medium/ high ) avec l'croissance$engrais A.

# Production laitiere 
```{r echo=FALSE}
# Lecture du fichier

head(vache)
``` 
Lecture du fichier
```{r echo=FALSE}
# Vérifions les effectifs par race
table(vache$race)
```
Races des vaches
```{r echo=FALSE}
# Moyenne de la production par race
tapply(vache$prod_lait, vache$race, mean)
```

La moyenne de production de lait par race de vache. 

```{r echo=FALSE}

tapply(vache$prod_lait, vache$race, summary)

```

```{r echo=FALSE}

# Visualisation
boxplot(vache$prod_lait ~ vache$race, col=c("lightblue","lightgreen","orange"), ylab="Production de lait (L/jour)" ,  main = "Production journalière de lait selon la race")

bp <- boxplot(prod_lait ~ race, data = vache,
              col = c("lightblue","lightgreen","orange"),
              ylab = "Production de lait (L/jour)",
              main = "Production journalière de lait selon la race")
```


## Tests préalables à l’ANOVA

Normalité (test de Shapiro-Wilk par race)
H0 : les données suivent une loi normale dans chaque groupe.

```{r echo=FALSE}
# La fonction by sert a appliquer une fonction , ici shapiro.test sur un data frame et appliquer ce test sur les differents facteurs. 
by(vache$prod_lait, vache$race, shapiro.test)
```

Les données observées pour chaque race suivent une loi normal.


Homogénéité des variances (test de Bartlett)
```{r echo=FALSE}
# On peut aussi utiliser data=vache pour eviter attach. ( ou remplacer vache$prod_lait)
bartlett.test(prod_lait ~ race, data=vache)
```


## ANOVA à 1 facteur (le facteur est race)

```{r echo=FALSE}
res <- aov(prod_lait ~ race, data=vache)
summary(res)
```
H0 : les moyennes de production de lait sont les mêmes entre races.
On a une p-value < 0.05, cela montre qu'il y'a au moins une race differente.

## Comparaisons multiples si ANOVA significative

Tests de Student par paires (avec correction Bonferroni)


```{r echo=FALSE}
pairwise.t.test(vache$prod_lait, vache$race, p.adjust.method="bonferroni")

```

On trouve des differences très significatives entre les 3 groupes. 

Les trois races de vaches produisent des quantités de lait significativement différentes.

On trouve des differences très significatives entre les 3 groupes. 

Les trois races de vaches produisent des quantités de lait significativement différentes.

Les vaches Jersiaise ont une production laitiere significativement plus importante que les vaches Bearnaise et Abondance.

Les vaches Bearnaise ont une porduction laitiere significativement plus importante que les vaches Abondances.
```{r echo=FALSE}
# install.packages("agricolae") # si non déjà installé
duncan.test(res, "race", alpha=0.05, console=TRUE)
```

```{r export_figures , include=FALSE}
# Exporter figures principales dans output/

# 1. Boxplot resistance
outfile_res <- file.path(path_output, "boxplot_resistance.jpg")
jpeg(outfile_res, width = 800, height = 600)
boxplot(resistance$score ~ resistance$lignee,
        col = "green", ylab = "score",
        main = "Scores de résistance par lignée")
dev.off()

# 2. Histogramme croissance (par engrais + température)
outfile_cro <- file.path(path_output, "boxplot_croissance.jpg")
jpeg(outfile_cro, width = 800, height = 600)
boxplot(croissance$hauteur ~ interaction(croissance$temperature, croissance$engrais),
        las = 3, col = "orange",
        ylab = "hauteur (cm)",
        main = "Hauteur selon température et engrais")
dev.off()

# 3. Interaction plot croissance
outfile_inter <- file.path(path_output, "interaction_plot_croissance.jpg")
jpeg(outfile_inter, width = 800, height = 600)
interaction.plot(croissance$temperature, croissance$engrais, croissance$hauteur,
                 main = "Interaction température x engrais",
                 ylab = "Hauteur moyenne (cm)", xlab = "Température")
dev.off()

# 4. Boxplot vaches
outfile_vac <- file.path(path_output, "boxplot_vaches.jpg")
jpeg(outfile_vac, width = 800, height = 600)
boxplot(vache$prod_lait ~ vache$race,
        col = c("lightblue","lightgreen","orange"),
        ylab = "Production de lait (L/jour)",
        main = "Production laitière selon la race")
dev.off()

# Vérification
list.files(path_output, pattern = ".jpg$")
```

