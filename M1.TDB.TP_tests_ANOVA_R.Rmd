---
title: "Compte rendu TP4 - Tests statistiques: Analyse de la Variance (ANOVA)"
author: "Laroussi Labid Bachri, M1 BBS"
date: "`r format(Sys.Date(), '%d-%m-%Y')`"
output:
  html_document:
    toc: TRUE
  pdf_document:
    toc: TRUE
    theme: 'flatly' 
editor_options: 
  chunk_output_type: console
---

```{r setup}
library(agricolae)
```


# Analyse de la variance (ANOVA)

Exploration jeu de données 

## ANOVA à 1 facteur (une variable qualitative)

```{r Exploration_jeu_de_donnes}
resistance <- read.table("Resistance.txt", header=T, stringsAsFactors=T); head(resistance) ; tail(resistance)
attach(resistance); names(resistance)

table(lignee)

tapply(score, lignee , mean )
# va appliquer la fonction mean sur le socre et les regrouper par lignees.
tapply(score, lignee, summary)
# va appliquer la fonction summary sur le socre et les regrouper par lignees.
hist(score, breaks=15, ylab="effectifs" )


boxplot(score~lignee, col="green", ylab="score")

```


## Test d'adéquation à la loi normale (H0 = "les données suivent la loi Normale")
```{r Tests_prealable_ANOVA}

shapiro.test(score[lignee=="HM008"])
shapiro.test(score[lignee=="A17"] )
shapiro.test(score[lignee=="DZA45"])
shapiro.test(score[lignee=="HM013"])
# Ou on fait tapply
tapply(score, lignee , shapiro.test )
```
On observe que les p value sont toutes superieures a 0.05 donc on accpete l'hypothese nulle.

## Test d'homogénéité des variances intra-groupes (H0 : "les variances sont égales")

```{r}


bartlett.test(score~lignee)


```

On trouve une p value de 0.6988. Les groupes ont donc des variances homogènes. 


## ANOVA à 1 facteur (le facteur est la variable "lignee") → H0 :"les moyennes des différents groupes sont égales"

```{r Test_Anova}
res = aov(score~lignee) # Test ANOVA

summary(res) # Afficher tableau ANOVA.
# Df = degre de liberte 
# sum square = somme ecart a la moyenne.

# Aire sous la courbe, p value = 1.18e-5. 
```


Toutes les moyennes ne sont pas egales. p value = 1.18e-5.

```{r visualiser_moyennees_chaque_groupe}

model.tables(res)

tapply(score , lignee , mean) - mean(score) # Differences de la moyenne par rapport a moyenne generale.

t.test(score[lignee=="DZA45"], score[lignee=="HM013"], var.equal=T)
t.test(score[lignee=="DZA45"], score[lignee=="HM008"], var.equal=T)
t.test(score[lignee=="DZA45"], score[lignee=="A17"], var.equal=T)
t.test(score[lignee=="A17"], score[lignee=="HM013"], var.equal=T)
t.test(score[lignee=="HM008"], score[lignee=="HM013"], var.equal=T)
t.test(score[lignee=="A17"], score[lignee=="HM008"], var.equal=T)

pairwise.t.test(score , lignee , pool.sd=F, p.adjust.method = "bonferroni" , var.equal=T)

# il va faire les tests 2 a 2 

# bonferroni va multipliler les p values et diviser le seuil par le nombre de tests. 

```




```{r}

kruskal.test(score~lignee)
wilcox.test(jitter(score[lignee=="HM008"]), jitter(score[lignee=="A17"]))
wilcox.test(jitter(score[lignee=="HM008"]), jitter(score[lignee=="DZA45"]))
# On peut utiliser jitter pour ajouter du bruti et eviter message d'avis wilcoxon.
duncan.test(res, "lignee", alpha=0.01, console=T)

pairwise.wilcox.test(score, lignee, p.adjust.method="bonferroni")

```


Conclusion = par rapport a la l'effet de lignée, on a un effet sgnificatif et on peut regrouper 3 lignees dans un groupe car pas de diff et le groupe qui est different dans un autre. 

## ANOVA à 2 facteurs (deux variables qualitatives) 

```{r Exploration_jeu_données}
croissance = read.table("Croissance.txt", header=T, stringsAsFactors=T) ; head(croissance)
layout( matrix( c(1,2,3,3) , nrow=2, ncol=2, byrow = FALSE))

boxplot(croissance$hauteur~croissance$engrais, main="engrais", ylab="hauteur (cm)")
boxplot(croissance$hauteur~croissance$temperature, main="temperature", ylab="hauteur (cm)")
boxplot(croissance$hauteur~croissance$temperature+croissance$engrais, main="engrais-temperature", ylab="hauteur (cm)", las=3)
```

4 groupes possibles car 2 variables qualitatives a 2 modalités. 


## Tests préalables à l'ANOVA

Test d'adéquation à la loi normale (H0 : "les données suivent la loi Normale")

```{r Test_Loi_normale}
tapply(croissance$hauteur , paste(croissance$engrais, croissance$temperature) , shapiro.test)
```

Test d'homogénéité des variances intra-groupes (H0 : "les variances sont égales")

On ne rejette pas Hà, ils suivnet une distribution normale. 

```{r}
bartlett.test(croissance$hauteur~interaction(croissance$engrais, croissance$temperature) )
```

On ne rejette pas la homogeneité des variances. 

ANOVA à 2 facteurs (les facteurs sont "engrais" et "température") → H0 : "les moyennes des différents groupes sont égales"
Modèle d'ANOVA où l'on teste l'effet de 2 facteurs ainsi que leur interaction

```{r}
model1 <- aov(croissance$hauteur~croissance$temperature*croissance$engrais)	
summary(model1)
interaction.plot(croissance$temperature, croissance$engrais,croissance$hauteur, main="interaction plot")
```

```{r}

model2 <- aov(croissance$hauteur~croissance$temperature+croissance$engrais)	
summary(model2)
```

0.023 est significative. Donc on a une interaction entre les 2 mais pour l'engrais seul sa p-value seule est superieure au seuil alpha.


Les droites se croisent donc y'a une interaction. 
si pas d'interaction les droite serait paralelle

## Comparaison des 2 modèles avec une ANOVA sur les résidus des 2 modèles
```{r comparaison_2modeles}
anova(model1, model2)
```

s'il n'y a pas de différence (p-value > 0.05), on garde le modèle le plus simple.
s'il y a une différence significative (p-value < 0.05), on garde le modèle présentant le plus de termes significatifs.

residus = poitns a cote de la moyenne

Anova donc les modeles differnets si y'a diff significatives. 
On prend le modele ou on a le plus de difference signficative.

```{r}
# plantes avec "engrais" différents

attach(croissance)
t.test(hauteur[engrais=="A" & temperature=="High"], hauteur[engrais=="B" & temperature=="High"], var.equal=T)     # comparaison A/B pour température "High"
t.test(hauteur[engrais=="A" & temperature=="Medium"], hauteur[engrais=="B" & temperature=="Medium"], var.equal=T) # comparaison A/B pour température "Medium"
# plantes avec "températures" différentes
t.test(hauteur[engrais=="A" & temperature=="Medium"], hauteur[engrais=="A" & temperature=="High"], var.equal=T)   # comparaison High/Medium pour l'engrais A
t.test(hauteur[engrais=="B" & temperature=="Medium"], hauteur[engrais=="B" & temperature=="High"], var.equal=T)   # comparaison High/Medium pour l'engrais B

```

remarque : on ne fait pas de pariwise car ça change toutes les possibilités au lieu de comparer 2 a 2 
Trop de tests 




